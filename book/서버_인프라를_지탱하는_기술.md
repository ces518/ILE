# 서버/인프라를 지탱하는 기술

## 다중화의 기본

#### 다중화란
- 다중화 (Redundancy) 란?, 장애가 발생해도 예비 운용장비로 시스템 기능을 계속할 수 있도록 하는것
- 웹서비스를 제공하는 네트워크나 서비스 에서도 가용성을 확보하기 위해 다중화 하는 것은 당연한 일이다.

#### 다중화의 본질
- 시스템의 다중화란 다음 단계를 실천한다.
1. 장애를 상정한다.
    - 다중화의 첫 걸음은 상애를 상정하는 것에서 시작
    - 라우터 장애로 서비스가 정지하거나, 서버 장애로 서비스가 정지하는 등.. 
2. 장애에 대비하여 예비 운용장비를 준비한다.
3. 장애가 발생했을 때 예비 운용장비로 교체할 수 있는 운용체제를 정비한다.

#### 라우터 장애시의 대응
- **Cold Standby** 란 ? 예비 운용장비를 보통 사용하지 않고 현재 운용장비에 장애가 발생하면 예비 운용장비로 연결하는 방식
- 라우터와 같은 네트워크 장비라면 운용중 설정을 변경하거나 저장할 데이터도 많지 않으므로 ColdStandby 방식이 현실적인 방법

#### 웹 서버 장애시의 대응
- 라우터와 마찬가지로 하면 될것 같지만 라우터와 웹 서버의 차이는 웹서버의 경우 컨텐츠가 오래되었거나, 버전이 맞지 않거나... 
- 캐시서버의 경우 충분히 캐시되지 않아 성능저하를 일으킬 수 있다. 다른 방법이 필요하다.
- **Hot Standby** 란 ? 두 대의 서버를 항상 가동시켜 두고 늘 같은 상태로 유지하는 방법이다.
> Cold Standby 의 경우 물리적인 회선연결 및 세팅시간이 필요해 다운타임이 길지만, Hot Standby의 경우 즉시 교체가 가능하다.

#### 장애 극복
- **장애 극복 (fail over)** 이란 ?현재 운용장비에 장애가 발생했을때 자동적으로 예비 운용장비로 처리를 인계하는 것
- 서버 장애를 극복하기 위해 가상 IP 주소 (Virtual IP Address) 와 IP 주소 인계를 활용한다.
- VIP를 이용한 Active/Backup 구성은 현재 운용장비인 A 서버에 VIP 1.2.3.4 를 할당해 두고 웹 서비스는 VIP 로 제공한다.
- 운용도중 장애가 발생했을 경우 VIP를 예비 운용장비인 B 서버에 할당하여 장애를 극복한다.

#### IP 주소를 인계하는 원리
- IP 주소 인계란 단순히 IP 주소를 바꿔 설정하는 것뿐 만이 아니다.
- LAN (Ethernet) 에서는 IP 주소가 아닌 NIC (Network Interface Card)에 고정적으로 할당되어 있는 MAC (Media Access Control Address)를 사용한다.
- 다른 서버에 보낼 때 MAC 주소를 얻기 위해 ARP (Address Resolution Protocol) 프로토콜을 사용한다.
    - ARP 는 IP 주소를 지정해 MAC 주소를 조회하기 위한 용도
    - 하지만 매번 조회하는건 비효율적이기 때문에 일정시간 캐싱한다.

#### 장애 검출 - 헬스체크
- **헬스체크 (Health Check)** 란? 정상적인 장애극복을 위해서는 현재 운용장비에서 장애가 발생하고 있음을 검출하는 방법이 필요하다.
- 이는 다양한 종류가 있어 적절한 것을 이용해야 한다.
1. ICMP 감시 (Layer 3)
    - ICMP의 echo 요청을 보내 응답이 오는지 체크한다. 가장 간단한 방법이지만 웹서비스가 다운된 경우 감지 불가능
    - 라우터에 의한 서비스 중지를 검출하기 위한 방법
2. 포트 감시 (Layer 4)
    - 포트 감시는 TCP로 접속을 시험해 접속가능여부를 체크한다. 웹서비스 다운 유무는 알 수 없지만 과부화 상태나 에러 반환을 감지할 수 있다.
3. 서비스 감지 (Layer 7)
    - 실제 HTTP 요청 등을 보내서 정상적인 응답이 오는지 체크한다. 대부분의 이상을 감지하지만 경우에 따라 서버에 부하를 유발할 수 있다.
    - 서버 장애에 의한 서비스 중지를 검출하기 위한 방법
> 헬스체크를 할 경우 **무엇을 확인하고자 하는가** 를 명확하게 아는것이 중요하다.

#### 부하분산
- Active/Backup 구성에서는 현재 운용장비만 접속을 처리하고 있고 예비 운용장비는 대기하고 있지만 아까운 상황이다.
- 여러대의 서버에 처리를 분산시켜 전체의 확장성을 향상시키는 방법을 부하분산 (Load Balance) 라고 한다.
- 접속자수가 늘어나서 처리가 따라가지 못하더라도 서버를 증설함으로써 대응할 수 있게 된다.

## 웹서버의 다중화 - DNS 라운드 로빈

#### DNS 라운드로빈
- DNS 를 이용해 하나의 서비스에 여러대의 서버를 분산시키는 방법
- 비교적 간단히 부하분산할 수 있는 DNS 라운드로빈 이지만 문제점이 존재한다.
1. 서버의 수 만큼 글로벌 주소가 필요하다.
2. 균등하게 분산되는 것은 아니다.
    - 모바일 기기로부터의 접속은 캐리어 게이트웨이라고 불리는 프록시 서버를 경유하는데 프록시 서버에서는 일정시간 캐싱하여 사용하므로
    - 프록시 서버를 경유하는 경우 같은 서버로 전달되는 문제가 있다.
3. 서버가 다운되어도 감지하지 못한다.

## 웹 서버의 다중화 - IPVS를 이용한 로드밸런서

#### DNS 라운드로빈과 로드밸런서의 차이
- 로드밸런서 (Load Balancer) 는 하나의 IP 주소에 대한 요청을 여러대의 서버로 분산할 수 있다.
- DNS 라운드 로빈과 다르게 글로벌 주소를 절약할 수 있음.
- 로드밸런서의 동작
    - 서비스용 글로벌 주소를 가진 가상 서버로 동작한다.
    - 클라이언트의 요청을 실제 웹서버로 분산함으로써 웹서버인것 처럼 동작한다.
- 로드밸런서의 기능
    - 여러 대의 웹서버중 한대를 선택하여 요청을 중계한다.
    - 헬스체크를 통해 정상동작중인 서버에만 요청을 중계하며, 한대가 정지 되더라도 정상 가동중인 서버가 존재하는 한 서비스가 정지하지 않는다.

#### IPVS - 리눅스로 로드밸런서 구성
- 리눅스는 별다른 소프트웨어 설치없이도 라우터로서 이용이 가능하다.
- 방화벽 등 여러 네트워크 기능들을 내장하고 있으며 **IPVS (Ip Virtual Server)** 라는 부하분산 기능을 제공하는 모듈을 포함하고 있다.

#### 로드밸런서의 종류와 IPVS의 기능
- 로드밸런서는 크게 L4와 L7 스위치 두 종류로 나뉜다.
- L4는 전송계층까지의 정보를 분석하므로 IP주소나 포트번호에 따라 분산 서버를 지정한다.
- L7은 응용계층 (애플리케이션 레이어)까지의 정보를 분석하므로 클라이언트로 부터 요청된 URL에 따라 분산대상 서버를 지정한다.

> IPVS 에 내장된 것은 L4에 해당하는 기능이다.

#### 스케쥴링 알고리즘
- IPVS에서는 몇가지 스케쥴링 알고리즘들이 있으며 주요 알고리즘 몇가지만 살펴본다.

| 명칭 | 동작 |
|---|---|
| rr(round-robin) | 순서대로 선택하며 요청을 분산한다. |
| wrr(weighted-round-robin) | rr과 같지만 가중치를 가미하여 분산한다. |
| lc(least-connection) | 접속수가 가장 적은 서버를 선택한다. 대부분의 경우 이것으로 충분하다. |
| wlc(weighted-least-connection) | lc와 같지만 가중치를 가미한다. |

#### IPVS 사용하기
- ipvsadm
- keepalived

#### ipvsadm
- IPVS를 개발한 곳에서 제공하는 명령줄 툴이다.
- 가상 서버 정의 및 리얼서버를 할당할 수 있을 뿐 아니라, 설정 내용 접속 상황 등 모니터링이 가능하다.

#### keepalived
- C언어로 작성된 데몬이다.
- /etc/keepalived/keepalived.conf 설정파일의 내용에 따라 IPVS 가상서버를 구축한다.
- 헬스체크 후 정상운용중인 서버로만 부하 분산을 진행하고, 모든 서버가 다운된 겨우 sorry_server 기능 이 있다.
- keepalived-1.1.15 에서 아래와 같은 헬스체크 기능을 제공
1. HTTP_GET
2. SSL_GET
3. TCP_CHECK
4. SMTP_CHECK
5. MISC_CHECK - 외부 명령을 실행해서 종료코드를 확인한다.

#### L4스위치와 L7스위치 - 심화
- 둘다 부하분산을 하지만 처리내용은 다르다.
- L4는 TCP 헤더 등 프로토콜의 헤더 내용을 분석하여 분산을 한다.
    - 클라이언트가 리얼서버와 TCP 세션을 전개한다.
- L7은 애플리케이션계층의 내부까지 분석하여 분산을 한다.
    - 로드밸런서와 클라이언트가 TCP 세션을 전개하고, 로드밸런서가 리얼서버와 TCP 세션을 전개하여 총 2개의 세션이 생성된다.
    
> 유연한 설정을 원한다면 L7, 성능을 추구한다면 L4 스위치를 선택

#### L4 스위치의 NAT 구성과 DSR 구성
- L4스위치는 NAT (Network Address Translation) 구성으로 이용할 수도 있지만, 성능을 추구한다면 DSR (Direct Server Return) 으로 구성할 수 있다.
- NAT 구성은 L4 스위치가 클라이언트의 요청 / 서버의 응답 두가지 모두 주소지를 변경작업을 수행한다.
- DSR 구성은 L4 스위치가 클라이언트의 요청에 대한 주소지를 변경하지 않고 서버의 응답은 클라이언트에게 직접 전송된다.

> 로드밸런서의 병목을 걱정하거나 높은 트래픽을 견디는 환경이 필요한 경우 DSR 구성을 추천한다.

- DSR 구성은 리얼서버가 글로벌 주소를 처리할 수 있어야 하며 NAT 구성에서 DSR 로 변경한다고 바로 동작하는것이 아니다.

#### 동일 서브넷인 서버를 부하분산할 경우 주의점
- 동일한 서브넷인 서버에 대해 부하분산을 할 경우 NAT 구성을 할 수 없다.
- NAT 구성에서는 로드밸런서가 목적지 IP 를 변경하기 때문에 응답이 로드밸런서로 돌아가지 않고 웹 서버로 직접 송신되는 문제가 있다.
- 이런 경우 DSR 구성으로 하는것이 좋다.