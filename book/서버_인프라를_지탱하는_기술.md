# 서버/인프라를 지탱하는 기술

## 다중화의 기본

#### 다중화란
- 다중화 (Redundancy) 란?, 장애가 발생해도 예비 운용장비로 시스템 기능을 계속할 수 있도록 하는것
- 웹서비스를 제공하는 네트워크나 서비스 에서도 가용성을 확보하기 위해 다중화 하는 것은 당연한 일이다.

#### 다중화의 본질
- 시스템의 다중화란 다음 단계를 실천한다.
1. 장애를 상정한다.
    - 다중화의 첫 걸음은 상애를 상정하는 것에서 시작
    - 라우터 장애로 서비스가 정지하거나, 서버 장애로 서비스가 정지하는 등.. 
2. 장애에 대비하여 예비 운용장비를 준비한다.
3. 장애가 발생했을 때 예비 운용장비로 교체할 수 있는 운용체제를 정비한다.

#### 라우터 장애시의 대응
- **Cold Standby** 란 ? 예비 운용장비를 보통 사용하지 않고 현재 운용장비에 장애가 발생하면 예비 운용장비로 연결하는 방식
- 라우터와 같은 네트워크 장비라면 운용중 설정을 변경하거나 저장할 데이터도 많지 않으므로 ColdStandby 방식이 현실적인 방법

#### 웹 서버 장애시의 대응
- 라우터와 마찬가지로 하면 될것 같지만 라우터와 웹 서버의 차이는 웹서버의 경우 컨텐츠가 오래되었거나, 버전이 맞지 않거나... 
- 캐시서버의 경우 충분히 캐시되지 않아 성능저하를 일으킬 수 있다. 다른 방법이 필요하다.
- **Hot Standby** 란 ? 두 대의 서버를 항상 가동시켜 두고 늘 같은 상태로 유지하는 방법이다.
> Cold Standby 의 경우 물리적인 회선연결 및 세팅시간이 필요해 다운타임이 길지만, Hot Standby의 경우 즉시 교체가 가능하다.

#### 장애 극복
- **장애 극복 (fail over)** 이란 ?현재 운용장비에 장애가 발생했을때 자동적으로 예비 운용장비로 처리를 인계하는 것
- 서버 장애를 극복하기 위해 가상 IP 주소 (Virtual IP Address) 와 IP 주소 인계를 활용한다.
- VIP를 이용한 Active/Backup 구성은 현재 운용장비인 A 서버에 VIP 1.2.3.4 를 할당해 두고 웹 서비스는 VIP 로 제공한다.
- 운용도중 장애가 발생했을 경우 VIP를 예비 운용장비인 B 서버에 할당하여 장애를 극복한다.

#### IP 주소를 인계하는 원리
- IP 주소 인계란 단순히 IP 주소를 바꿔 설정하는 것뿐 만이 아니다.
- LAN (Ethernet) 에서는 IP 주소가 아닌 NIC (Network Interface Card)에 고정적으로 할당되어 있는 MAC (Media Access Control Address)를 사용한다.
- 다른 서버에 보낼 때 MAC 주소를 얻기 위해 ARP (Address Resolution Protocol) 프로토콜을 사용한다.
    - ARP 는 IP 주소를 지정해 MAC 주소를 조회하기 위한 용도
    - 하지만 매번 조회하는건 비효율적이기 때문에 일정시간 캐싱한다.

#### 장애 검출 - 헬스체크
- **헬스체크 (Health Check)** 란? 정상적인 장애극복을 위해서는 현재 운용장비에서 장애가 발생하고 있음을 검출하는 방법이 필요하다.
- 이는 다양한 종류가 있어 적절한 것을 이용해야 한다.
1. ICMP 감시 (Layer 3)
    - ICMP의 echo 요청을 보내 응답이 오는지 체크한다. 가장 간단한 방법이지만 웹서비스가 다운된 경우 감지 불가능
    - 라우터에 의한 서비스 중지를 검출하기 위한 방법
2. 포트 감시 (Layer 4)
    - 포트 감시는 TCP로 접속을 시험해 접속가능여부를 체크한다. 웹서비스 다운 유무는 알 수 없지만 과부화 상태나 에러 반환을 감지할 수 있다.
3. 서비스 감지 (Layer 7)
    - 실제 HTTP 요청 등을 보내서 정상적인 응답이 오는지 체크한다. 대부분의 이상을 감지하지만 경우에 따라 서버에 부하를 유발할 수 있다.
    - 서버 장애에 의한 서비스 중지를 검출하기 위한 방법
> 헬스체크를 할 경우 **무엇을 확인하고자 하는가** 를 명확하게 아는것이 중요하다.

#### 부하분산
- Active/Backup 구성에서는 현재 운용장비만 접속을 처리하고 있고 예비 운용장비는 대기하고 있지만 아까운 상황이다.
- 여러대의 서버에 처리를 분산시켜 전체의 확장성을 향상시키는 방법을 부하분산 (Load Balance) 라고 한다.
- 접속자수가 늘어나서 처리가 따라가지 못하더라도 서버를 증설함으로써 대응할 수 있게 된다.

## 웹서버의 다중화 - DNS 라운드 로빈

#### DNS 라운드로빈
- DNS 를 이용해 하나의 서비스에 여러대의 서버를 분산시키는 방법
- 비교적 간단히 부하분산할 수 있는 DNS 라운드로빈 이지만 문제점이 존재한다.
1. 서버의 수 만큼 글로벌 주소가 필요하다.
2. 균등하게 분산되는 것은 아니다.
    - 모바일 기기로부터의 접속은 캐리어 게이트웨이라고 불리는 프록시 서버를 경유하는데 프록시 서버에서는 일정시간 캐싱하여 사용하므로
    - 프록시 서버를 경유하는 경우 같은 서버로 전달되는 문제가 있다.
3. 서버가 다운되어도 감지하지 못한다.