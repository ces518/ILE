# 기초부터 다지는 ElasticSearch 운영노하우

## 1장 ElasticSearch 훑어보기

### 검색 시스템
- 최근에는 **검색 서비스** 가 일상에서 빼놓기 힘든 서비스로 자리 매김 했다.
- 이런 서비스 들을 부르는 용어들도 다양한데, 검색 엔진, 검색 시스템, 검색 서비스 등에 대해 살펴본다.

#### 검색 엔진
- 검색엔진은, 컴퓨터 시스템에 저장된 정보를 찾아주는 것을 도와주도록 설계된 **정보 검색 시스템**
- 웹에서 정보를 수집해 검색 결과를 제공하는 프로그램이다. 
- 검색 결과로 제공되는 데이터의 특성에 따라 구현 형태가 각각 달라진다.
- 야후는 디럭테리 기반의 검색 결과를 세계 최초로 제공했다.
- 초기 검색엔진은 웹 디렉터리 기반으로 하고 있었지만, 지금은 웹 디렉터리를 검색엔진이라 하지 않는 편이다.

> 서버에서는, **로봇** 이라 불리는 프로그램을 이용해 웹 사이트들에 대한 정보를 미리 수집한다.

#### 검색 시스템
- 검색 시스템은 **검색 엔진을 기반으로 구축된 시스템** 을 통칭
- 다수의 검색 엔진을 이용해 **색인** 하고 검색 결과를 제공한다.

#### 검색 서비스
- 검색 서비스는 검색 엔진을 기반으로 구축한 검색 시스템을 활용해 검색 결과를 **서비스로 제공** 한다.

> 검색 서비스 > 검색 시스템 > 검색 엔진

#### 구성요소
- 수집기
    - 웹에서 필요한 정보를 수집하는 프로그램
    - 크롤러, 스파이더, 웜, 웹로봇 등으로 불린다.
- 스토리지
    - 데이터를 저장하는 물리적인 저장소
    - 색인한 데이터를 스토리지에 보관한다.
- 색인기
    - 수집된 데이터를 검색 가능한 구조로 가공 및 저장하는 역할
    - 다양한 **형태소 분석기** 를 활용하여 검색에 유리한 **역색인 구조** 로 데이터를 저장한다.
- 검색기
    - 사용자의 질의를 받아 색인기에서 저장한 역색인 구조에서 일치하는 문서를 찾아 결과를 반환한다.
    - 검색기 또한 형태소 분석기를 사용해, 사용자 질의에서 유의미한 용어를 추출해 검색한다.
    - 사용하는 형태소 분석기에 따라 검색 품질이 달라진다.
 

#### 역색인
- **색인** 은, 빠른 검색을 위해 검색 될 만한것 (Lexicon) 들의 존재 여부와 위치 (Positing) 를 미리 추출하여, 빠른 탐색 자료구조를 구축해 두는것
- **역색인** 은, 어떤 키워드가 주어졌을때, 어느 문서에 속해있는지 목록을 유지하는 자료구조를 구축해 두는것

`역색인의 구축 과정`
1. 원문에서 색인어를 추출
2. 각 문서당 색인어수를 카운트
3. 키워드 순서대로 정렬
4. 키워드 마다 역색인 벡터를 생성
5. 역색인 벡터를 압축
6. 키워드당 검색 순위를 미리 만듦
7. Lexicon 을 Hashing, BTree, TRIE 자료구조로 색인

> 실시간 검색 속도 문제를 보완 하기 위해서는, 색인 만으로는 한계가 존재한다.
> 검색 속도의 향상을 위해 역색인 하는것이 필요

- https://github.com/ces518/TIL/blob/master/elasticsearch/역색인%20구조.md

### ElasticSearch 란 ?
- 대량의 데이터를 빠르게 조회하기 위해서는, NoSQL 을 많이 사용한다.
- 엘라스틱 서치도 NoSQL 의 일종이며, **루씬 (Lucene)** 기반의 오픈소스 검색 엔진
- **JSON** 기반의 문서를 저장하고, 검색이 가능하며 문서들의 데이터 기반으로 분석작업이 가능하다.

#### 특징
- 루씬 기반
- 실시간 분석
- 분산 시스템
- 고 가용성
- 멀티 테넌시
- 전문 검색
- JSON 문서 기반
- RESTful API
- 단점

`아파치 루씬 기반`
- 아파치 루씬은, 자바로 개발된 검색 라이브러리
- 엘라스틱 서치를 비롯한 솔라, 티카와 같은 프로젝트에서 널리 사용되고 있음
- 매우 강력한 기능이 있는 검색엔진이며, 위치정보 활용, 다국어 검색, 철자 수정, 자동완성, 미리 보기 등 다양한 기능을 지원한다.

`실시간 분석`
- 엘라스틱 서치에 저장된 데이터를 검색에 사용하게 위해 별도의 재시작 또는 상태 갱신이 필요하지 않다.

`분산 시스템`
- 다수의 노드로 구성되는 분산 시스템
- 엘라스틱 서치의 **노드** 는 데이터를 색인하고 검색 기능을 수행하는 **단위 프로세스** 이다.
- 소규모 시스템에서는 적은 수의 노드로 시스템을 구성한뒤 규모가 커지면 기존 노드에 새 노드를 연결하는 것으로 쉽게 확장이 가능하다.
- 데이터는 각 노드에 분산 저장되어, 복사본을 유지해 데이터 유실을 방지한다.

`고 가용성`
- 엘라스틱 서치는 하나 이상의 노드로 구성됨
- 각 노드는 하나 이상의 데이터 원본과 복사본을 가지고 있으며 서로 다른 위치에 나누어 저장한다.
- 노드가 종료되거나 실행에 실패하는 경우, 노드들의 상태를 감지 (노드 간에 **메쉬** 형태로 통신) 하고 종료된 노드가 있다면 해당 노드가 가지고 있던 데이터를 다른 노드로 옮긴다.
- 엘라스틱 서치는 이런 과정으로 항사 일정한 데이터 복사본의 개수를 유지하고 **고 가용성과 안전성을 보장** 한다.

`멀티 테넌시`
- 엘라스틱 서치의 데이터는 여러 개의 분리되 인덱스들 (indices) 에 그룹으로 저장된다.
- 관계형 데이터베이스 에서는 다른 데이터베이스의 데이터를 검색하려면, 별도의 커넥션을 생성해야한다.
- 하지만 엘라스틱서치에서는 서로 다른 인덱스의 데이터를 하나의 질의로 묶어 검색하고 여러 검색 결과를 하나의 출력으로 도출할 수 있다.

`전문 검색`
- 엘라스틱 서치는 데이터 색인을 통한 전문 검색 (Full-Text Search) 를 지원한다.

`JSON 문서 기반`
- 엘라스틱서치의 모든 데이터는 기본적으로 문서의 모든 필드가 색인되며, JSON 구조로 저장된다.
- 모든 레벨의 필드에 접근이 쉽고, 매우 빠른속도로 검색된다.
- NoSQL 과 같이 Schemaless 를 지원하므로, 별도의 사전 매핑 없이 JSON 문서 형식으로 데이터를 입력하면, 바로 검색 가능한 구조로 색인 작업이 수행된다.

`RESTful API`
- 엘라스틱서치의 진입 장벽을 낮춰준 장점
- RESTful API 를 지원하기 때문에 언어에 구애받지도 않고, OS 의 기본적인 툴로도 손쉽게 사용이 가능하다.

`단점`
1. 실시간이 아니다.
    - 일반적으로 색인된 데이터는 약 1초정도 뒤에 검색이 가능해진다.
    - 이를 **준 리얼타임** 이라고 한다.
2. 트랜잭션가 롤백 기능을 제공하지 않는다.
    - 전체 클러스터 성능의 향상을 위해 롤백과 클러스터를 지원하지 않는다.
    - 최악의 경우 데이터 손실의 위험
3. 데이터 업데이트를 제공하지 않는다.
    - 엘라스틱서치는 업데이트 명령시, 기본 문서를 삭제하고 변경된 내용으로 **재 생성** 한다.
    - Immutable 하게 동작한다.

#### 관계형 데이터베이스와의 비교
- 검색엔진의 비교 대상은 항상 관계형 데이터베이스 이다.
- 관계형 데이터베이스는 데이터를 구조화하고, 형과 열로 구성된 테이블에 데이터를 저장하기 떄문에 비즈니스에 적합 (Command)
- 검색엔진은 데이터베이스에서 불가능한 비정형 데이터를 색인하고 검색에 최적화 되어 있다. (Query)

| 엘라스틱 서치 | 관계형 데이터베이스 |
| --- | --- |
| 인덱스 | 데이터베이스 |
| 샤드 | 파티션 |
| 타입 | 테이블 |
| 문서 | 행 (Row) |
| 필드 | 열 (Column) |
| 매핑 | 스키마 |
| Query DSL | SQL |

#### MongoDB 와의 비교

| - | MongoDB | 엘라스틱서치 |
| --- | --- | --- |
| 구분 | 데이터 저장소 | 루씬기반 검색엔진 |
| 개발 언어 | C++ | Java |
| 운영체제 | Linux, MacOSX, 솔라리스, 윈도우 | JVM 이 구동가능한 모든 OS |
| 접속 방식 | 자체 프로토콜 | RESTful / HTTP API |
| 문서 구조 | JSON | JSON |

> 데이터 저장이 중요한 시스템에서는 MongoDB, 검색이 중요한 시스템에서는 엘라스틱서치를 사용하도록 권장하고 있다.