# 실전 스프링부트와 JPA 활용 1 - 웹애플리케이션 개발 - 웹계층 개발_변경감지와 병합

#### 변경감지와 병합(merge)
- 반드시 이해해야 한다.

`준영속 엔티티`
- 영속성 컨텍스트가 더는 관리하지 않는 엔티티를 말한다.
- 임의로 만들어낸 엔티티라도, 기존 식별자를 가지고 있다면 준영속 엔티티가 된다. (DB에 한번 저장된 엔티티)

`수정하는 2가지 방법`
- 변경 감지 기능
- 병합(merge) 사용

`변경 감지 기능 사용`
```java
@Transactional
public void updateItem (Long itemId, Book paramBook) {
    Item findItem = itemRepository.findOne(itemId);
    findItem.setPrice(paramBook.getPrice());
    findItem.setStockQuantity(paramBook.getStockQuantity());
}
```

> itemRepository에서 itemId를 이용해 조회를 한뒤, 조회한 엔티티의 데이터를 수정하여 변경감지 기능을 활용한다.
> - 트랜잭션 커밋시점에 변경감지가 일어나 update 쿼리가 날아간다.

`병합 사용`
- 병합은 준영속 상태의 엔티티를 영속 상태로 만드는 메소드이다.
    - 매우 간단하게 설명하면 위의 변경감지 기능에서 소개한 로직과 흡사하다.

`병합 동작 방식`
- merge 실행
- 파라메터로 넘어온 준영속 엔티티의 식별자로 1차 캐시에서 엔티티를 조회한다.
    - 만약 없다면 데이터베이스에서 엔티티를 조회하고, 1차캐시에 젖아한다.
- 조회한 영속 엔티티에 파라메터로 넘어온 엔티티의 값으로 모두 바꿔치기 한다.
- 바꿔치기 된 것을 반환 해준다.

> 파라메터로 넘어온객체가 영속성 컨텍스트에서 관리하는 객체가 아니고 **merge()를 호출하여 반환된 객체만 영속성 컨텍스트에서 관리하는 객체이다**.

`병합 사용시 주의점`
- 병합시 모든 속성이 변경된다.
    - 선택적인 수정이 불가능하다.
- 파라메터의 값이 null이라면 ? null값으로 대체된다.

> 병합(merge)는 매우 위험한 방식이다. 실무에서는 최대한 지양 할것

의미있는 메소드를 사용하는것이 좋다.
setter를 사용하는것은 매우 좋지않은 방법.
> setter를 사용하면 역추적이 힘들다.

#### 가장 좋은 해결방법
- 병합을 사용하지않고, 변경 감지를 사용할것
- 컨트롤러에서 어설프게 엔티티를 생성하지 말것
- 트랜잭션이 있는 서비스계층에 식별자와, 변경할 데이터를 명확하게 전달 (파라메터 or DTO)
