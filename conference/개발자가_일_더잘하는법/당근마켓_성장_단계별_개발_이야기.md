# 당근마켓 성장 단계별 개발 이야기

## 2015-12 ~
- Ruby On Rails
- AWS EC2

`Ruby On Rails`
- 빠른 개발속도
- 3명중 2명이 레일스에 익숙함
- 새로운 기능을 붙일때 빠르게 붙일 수 있음
- DB 스키마까지 모두 생성해줌
- ORM 끝판왕 **Active Record**
- 카카오에서 이미 많이 사용됨
- 카카오만큼 커지면 전환해도 된다.
    - 카카오도 실제로 많은 부분이 전환됨
- 대부분의 서비스는 커지기도 전에 망함
- 빠른 적용과 변화에 적절하다.
- 채용하기가 힘들다.
- 대부분 서비스느 성장하기도 전에 망하니 시작하자.

`AWS EC2`
- 도커를 잘 알고 있었다.
- 초기에는 Docker를 사용하지 않는게 더 이득임
- Capistrano 배포가 Docker 보다 더 빠르고 장점이 많았다.
- Docker 사용하면 이미지 빌드, 배포, 관리 등할게 많다.
- 서비스 변화에 빠른 대응을 위해 단순한게 좋다.
- DB, Redis 는 AWS 관리 서비스 사용
- AWS RDS
   - PostgreSQL
   - PostGIS, JSON 인덱스 등 기능 많음
   - 현재는 MySQL 에서도 많은 기능 제공
- AWS Elasticache (redis)
    - Redis 대안
    - 일반적으론 Redis 는 죽어도 다시 살아내며 복구됨
        - Redis 는 디스크에서 복구
    - Multi AZ (IDC 개념) 사용하지 않음
        - 특정 IDC 가 죽어도 다른 IDC로 복구
    - 메모리가 다 차면 죽고, 순식간에 다시 실행된다.
    - 최근에는 다 차도 죽지 않는다.
    - 캐시는 목적에 따라 Memcached / 다수의 Redis 로 여러개로 분리

> 완벽한 스택으로 만들어봤자 대부분 망한다.
> 초기 서비스일 경우 개발 스택보다 빠른 변화에 대응하지 못해 망한다.
> 완벽한 CI/CD 힘들게 만들어도 사이클 돌기전에 망함
> 개발 리소스가 제한된 환경에서는 핵심에 리소스를 쏟아라.

#### Startup - Eric Reis
- 스타트업은 극심한 불확실성의 상황 하에 새로운 제품이나 서비스를 만들어내기 위한 조직

#### 2018-1
- AWS VPC
    - 네트워크를 public, private 망분리
        - 대부분의 보안 문제를 해결해줌
    - 기존에는 신경쓰지 않았고, 이때 아니면 못했을거 같다.
    - 지금은 기본으로 제공함

- Terraform
    - AWS 클라우드를 코드로 생성/제거한다.
    - 기존에는 AWS콘솔에서 하나씩 생성
    - 기존에 어떤 옵션으로 생성했는지 추적이 안된다.
    - 따로 정리해두지 않으면 서비스를 그대로 실행할 방법도 없음
    
> 안정적인 서비스를 위한 사전 작업

#### ~2019
- 늘어나는 트래픽과 늘어나는 서버로 인한 연속적인 장애
- DB(RDS) CPU 문제들이 하나씩 나오기 시작
    - RDS 스케일 업
    - 쿼리 튜닝, 캐시 추가
    - 개선후 트래픽 늘어서 또 문제
- 웹서버 갯수가 늘어남
    - Capistrano 는 SSH 기비반
    - 서버가 40대가 넘어가기 시작하니 한두대씩 실패하여 전체배포가 안되기 시작
    - 40대 서버의 AMI 이미지 교체 작업이 힘들다.
- AWS EC2 Docker 사용
    - 이를 사용해야겠다는 결정이 4년이 걸림
    - 이제는 사용하는것이 장점
    - 서버 대수가 늘어나니 도입할 수 밖에 없다.
    - 기존에 잘되던것을 Docker 기반에서도 잘되게 하는게 쉽지 않음
        - log
            - DataDog -> Loki
        - 파일 쓰기
            - 로컬 파일시스템에 두기가 힘들어짐
        - ssh 접속
            - ECS Fargate 를 이용해서 별도로 실행
        - 배포속도가 느림
            - Capistrano 시절 보다 불편한점이 있다.
        - Cron
            - ECS Schedule Task 이용
    - AWS ECS 를 통해 Docker 실행
> 개발자들의 생산성 측면에서는 Docker 가 좋지는 않음.

#### 2019 중순
- 채팅서버 분리, Go 언어 도입
- 1년전에 시도 했지만 실패
- 기존에는 HTTP Push 기능 -> Web Socket
- 1년이 걸림. 레거시 전환이 어렵다.
- 한 프로젝트를 오랜 기간하는것은 당사자들이 가장 힘듦

#### TypeScript 도입
- 새로운 사업확장시 레일스로는 한계가 있음
- 모노리스에서 분리하는 프로젝트에서 TypeScript 해보기로 결정
- 레일스에 비해 웹프레임워크로서 부족한 부분들이 있음
- 적응하기가 힘들지 않았다.
- TypeScript 개발자 채용도 쉽지 않음

#### 핵심은 레거시
- 정지를 하지 못한다.
- 레거시 클라이언트를 계속 유지 해야함
- 레거시 시스템과 신규시스템 동시에 만족하는 분리 작업

#### 마이크로 서비스
- 예상치 못한 문제 발생
- 조금이라도 latency 발생시 최종 요청에 영향이 간다.
- 현재 서버응답은 평균 70ms 내로 유지중
- gRPC 도입시 내부 트래픽이 많아도 문제없이 잘될줄 알았음
- 클라이언트 옵션을 잘 조정하지 않으면 http, gRPC 모두 네트워크 문제 발생
    - keep alive, timeout
    - EKS Pod IP 직접 사용, DNS 이용시 접속이 잘 안되는 문제
- 문제가 옆으로 전파되는 경우도 있다. 원인을 찾기가 힘듬

- 장점
    - 언어에 대한 제약이 없어져서 채용에 다양성이 생김
- 서비스: 루비
- 사업: 자바, 타입스크립트
= 글로벌: 루비
- 플랫폼: 고, 파이썬(머신러닝)
- 채용의 유연함이 생김

#### 계획
- EKS
- Kafka
- 테스트
- 자동화
- 루비 버전업
- 코틀린
- 데이터 파이프라인
- 머신러닝

#### 개발 문화
- 개발자들이 업무적으로 본인이 하고 싶은것을 하는것이 중요하다.
- 업무시간이 즐거워야 한다.